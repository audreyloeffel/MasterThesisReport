\chapter{Sparse Formats}

\section{Vectors and Matrices}


There exists several different formats to store a sparse array. The idea behind using a sparse format instead of the classic dense one, is to reduce the memory space and the executing time of the operations. Knowing that a matrix is sparse allows to shortcut some operation steps. For example during a matrix multiplication, we can avoid to perform the multiplication for the zero elements of the sparse matrix.

\subsection{Coordinate format (COO)}

This format is the simplest format to encode a sparse array. The coordinates and the value of each non-zero entry are stored in arrays.
Typically each element are encoded in a tuple (row, column, value)

Some implementation variations of the COO format exist. The elements can be sorted along a dimension, or it can be some duplicate indexes.

\begin{figure}[h]
\[
A_{(M\times N)} = 
\begin{bmatrix}
0 &  2 & 0 \\
0 &  0 & 3 \\
1 &  0 & 4\\
0 &  0 & 0
\end{bmatrix}
\quad\rightarrow\quad
\begin{aligned}
Values_{(1\times NNZ)} = 
\begin{bmatrix}
2 &  3 & 1 & 4
\end{bmatrix}
\\
Rows_{(1\times NNZ)} = 
\begin{bmatrix}
0 &  1 & 2 & 2
\end{bmatrix}
\\
Columns_{(1\times NNZ)} = 
\begin{bmatrix}
1 &  2 & 0 & 2
\end{bmatrix}
\end{aligned}
\]
\caption{A matrix stored in COO format}
\end{figure}
With this format it's easy and fast to retrieve the value given an index and to insert a new non-zero element.. It's also fast and simple to convert into a dense format.

But this format don't minimize the memory space. It can be reduced with a compressed format such as CSR or CSC as described below.

\subsection{Compressed Row Format (CSR)}
The Compressed Row and the Compressed Column formats are the most general format to store a sparse array. They don't store any unnecessary element. But it requires more steps to access the elements than the COO format. 

Each non-zero element of a row are stored contiguously in the memory. Each row are also contiguously stored.

The format requires four arrays:
\begin{description}
	\item [Values] All the nonzero values are store contiguously in an array. The array size is {NNZ}.
	\item [Column pointers] This array keeps the column position for each values.
	\item [Beginning of row pointers] Each pointer $i$ points to the first element of the row $i$ in the values array. The array size is the number of rows of the array.
	\item [End of row pointers]  Each pointer $i$ points to the first element in the values array that does not belong to the row $i$ . The array size is the number of rows of the array.
\end{description}

\begin{figure}
\[
A_{(N\times M)} = 
\begin{bmatrix}
0 & 2 & 0 & 0\\
0 & 0 & 3 & 0\\
0 & 0 & 0 & 0\\
1 & 0 & 4 & 0\\
0 & 0 & 2 & 1
\end{bmatrix}
\quad\rightarrow\quad
\begin{aligned}
Values_{(1\times NNZ)} = 
\begin{bmatrix}
2 &  3 & 1 & 4 & 2 & 1
\end{bmatrix}
\\
Columns_{(1\times NNZ)} = 
\begin{bmatrix}
1 &  2 & 0 & 2 & 2 & 3
\end{bmatrix}
\\
pointersB_{(1\times N)} = 
\begin{bmatrix}
0 & 1 & 2 & 2 & 4 
\end{bmatrix}
\\
PointersE_{(1\times N)} = 
\begin{bmatrix}
1 & 2 & 2 & 4 & 6
\end{bmatrix}
\\
\end{aligned}
\]
\caption{A matrix stored in CSR format}
\end{figure}
\subsection{Compressed Colum Format (CSC)}
The Compressed Column Format is similar to {CSR} but it compresses columns instead of rows.

Given a matrix $N\times M$, the pointers arrays will have a size $M$. 
\section{Tensors / N-dimensional arrays}

A tensor is a multi-dimensional array. The order of the tensor is the dimensionality of the array needed to represent it. Matrices and vectors can be represented as tensors where the order is equals to 2 and 1 respectively.

This generalization allows a more generic implementation of a n-dimensional array in the Nd4j library.

\subsubsection{Coordinate format (COO)}
The COO format can easily be extended to encode tensors by storing an array of indexes instead the row and column coordinates. 

A array of order $K = 3$ with shape $N\times M \times P$ which has the following non-zero values :
\begin{center}
	\begin{tabular}{ l | c  }
		value & indexes\\ \hline
		1 & 0 1 0\\ \hline
		2 & 1 1 2 \\ \hline
		3 & 1 2 0 \\ \hline
		4 & 2 0 1 \\ \hline
		5 & 2 2 0 \\ 
		
	\end{tabular}
\end{center}

can be encoded with one values array and one indexes array :
\begin{figure}[h]
\[
\begin{aligned}
Values_{(1\times NNZ)} = 
\begin{bmatrix}
1, &  2, & 3, & 4, & 5
\end{bmatrix}
\\
Indexes_{(NNZ \times K)} = 
\begin{bmatrix}
[0, 1, 0] ,&  [1, 1, 2], & [1, 2, 0], & [2, 0, 1], & [2, 2, 0]
\end{bmatrix}
\end{aligned}
\]
\caption{A tensor stored in COO format}
\end{figure}
\subsubsection{Compressed Sparse Fiber}